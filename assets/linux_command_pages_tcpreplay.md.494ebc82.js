import{_ as s,c as a,o as n,a as p}from"./app.82736834.js";const C=JSON.parse('{"title":"tcpreplay","description":"","frontmatter":{},"headers":[{"level":2,"title":"补充说明","slug":"补充说明","link":"#补充说明","children":[{"level":3,"title":"选项","slug":"选项","link":"#选项","children":[]},{"level":3,"title":"实例","slug":"实例","link":"#实例","children":[]}]}],"relativePath":"linux/command/pages/tcpreplay.md","lastUpdated":1666509709000}'),l={name:"linux/command/pages/tcpreplay.md"},e=p(`<h1 id="tcpreplay" tabindex="-1">tcpreplay <a class="header-anchor" href="#tcpreplay" aria-hidden="true">#</a></h1><p>将PCAP包重新发送，用于性能或者功能测试</p><h2 id="补充说明" tabindex="-1">补充说明 <a class="header-anchor" href="#补充说明" aria-hidden="true">#</a></h2><p>简单的说， <strong>tcpreplay</strong> 是一种pcap包的重放工具，它可以将用ethreal、wireshark工具抓下来的包原样或经过任意修改后重放回去。它允许你对报文做任意的修改（主要是指对2层、3层、4层报文头），指定重放报文的速度等，这样tcpreplay就可以用来复现抓包的情景以定位bug，以极快的速度重放从而实现压力测试。</p><h3 id="选项" tabindex="-1">选项 <a class="header-anchor" href="#选项" aria-hidden="true">#</a></h3><div class="language-shell line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-darker" tabindex="0"><code><span class="line"><span style="color:#FFCB6B;">-A</span><span style="color:#EEFFFF;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">&lt;args&gt;</span><span style="color:#89DDFF;">&quot;</span><span style="color:#EEFFFF;"> </span><span style="color:#C3E88D;">在使用</span><span style="color:#EEFFFF;"> </span><span style="color:#C3E88D;">tcpdump</span><span style="color:#EEFFFF;"> </span><span style="color:#C3E88D;">风格打印输出信息时，同时再调用tcpdump中的参数，</span><span style="color:#EEFFFF;"> </span><span style="color:#C3E88D;">默认已经带有“-n,-l”，所以一般看到的都是ip地址，而没有主机名的打印，注意这个是在tcpreplay使用了-v参数时才能使用，不带-v不会报错，但是没有实际意义。格式：-vA</span><span style="color:#EEFFFF;"> </span><span style="color:#C3E88D;">“nnt”表示以tcpdump风格输出报文信息，并且不打印时间戳、主机名、端口服务名称。注意不要使用-c参数来指定打印的数据报文的个数，这样发送出去的报文也会变少。</span></span>
<span class="line"><span style="color:#FFCB6B;">-c</span><span style="color:#EEFFFF;"> </span><span style="color:#89DDFF;">&lt;</span><span style="color:#C3E88D;">cachefil</span><span style="color:#EEFFFF;">e</span><span style="color:#89DDFF;">&gt;</span><span style="color:#EEFFFF;"> </span><span style="color:#C3E88D;">双网卡回放报文必选参数，后面紧跟cache文件名，该文件为tcpprep根据对应的pcap文件构造出来。</span><span style="color:#EEFFFF;"> </span></span>
<span class="line"><span style="color:#FFCB6B;">-D</span><span style="color:#EEFFFF;"> </span><span style="color:#C3E88D;">把应用层的数据，使用dump</span><span style="color:#EEFFFF;"> </span><span style="color:#C3E88D;">mode写入到指定文件中去，和-w、-W</span><span style="color:#EEFFFF;"> </span><span style="color:#C3E88D;">参数一起使用。</span><span style="color:#EEFFFF;"> </span></span>
<span class="line"><span style="color:#FFCB6B;">-e</span><span style="color:#EEFFFF;"> </span><span style="color:#89DDFF;">&lt;</span><span style="color:#C3E88D;">ip1:ip</span><span style="color:#89DDFF;">2&gt;</span><span style="color:#EEFFFF;"> </span><span style="color:#C3E88D;">指定端点的ip，即把发送报文的和接收的报文的ip都修改称对应的参数值中指定的ip，但是这样发送的出的报文不会区分client和server。。</span><span style="color:#EEFFFF;"> </span></span>
<span class="line"><span style="color:#FFCB6B;">-f</span><span style="color:#EEFFFF;"> </span><span style="color:#89DDFF;">&lt;</span><span style="color:#C3E88D;">configfil</span><span style="color:#EEFFFF;">e</span><span style="color:#89DDFF;">&gt;</span><span style="color:#EEFFFF;"> </span><span style="color:#C3E88D;">指定配置文件。</span></span>
<span class="line"><span style="color:#FFCB6B;">-F</span><span style="color:#EEFFFF;"> </span><span style="color:#C3E88D;">在发送报文时，自动纠正错误的校验和。对测试DUT的校验和检验。</span></span>
<span class="line"><span style="color:#FFCB6B;">-h</span><span style="color:#EEFFFF;"> </span><span style="color:#C3E88D;">显示帮助文件。</span><span style="color:#EEFFFF;"> </span></span>
<span class="line"><span style="color:#FFCB6B;">-i</span><span style="color:#EEFFFF;"> </span><span style="color:#89DDFF;">&lt;</span><span style="color:#C3E88D;">ni</span><span style="color:#EEFFFF;">c</span><span style="color:#89DDFF;">&gt;</span><span style="color:#EEFFFF;"> </span><span style="color:#C3E88D;">双网卡回放报文必选参数，指定主接口。</span></span>
<span class="line"><span style="color:#FFCB6B;">-I</span><span style="color:#EEFFFF;"> </span><span style="color:#89DDFF;">&lt;</span><span style="color:#C3E88D;">ma</span><span style="color:#EEFFFF;">c</span><span style="color:#89DDFF;">&gt;</span><span style="color:#EEFFFF;"> </span><span style="color:#C3E88D;">重写主网卡发送出报文的目的MAC地址。</span><span style="color:#EEFFFF;"> </span></span>
<span class="line"><span style="color:#FFCB6B;">-j</span><span style="color:#EEFFFF;"> </span><span style="color:#89DDFF;">&lt;</span><span style="color:#C3E88D;">ni</span><span style="color:#EEFFFF;">c</span><span style="color:#89DDFF;">&gt;</span><span style="color:#EEFFFF;"> </span><span style="color:#C3E88D;">双网卡回放报文必选参数，指定从接口。</span></span>
<span class="line"><span style="color:#FFCB6B;">-J</span><span style="color:#EEFFFF;"> </span><span style="color:#89DDFF;">&lt;</span><span style="color:#C3E88D;">ma</span><span style="color:#EEFFFF;">c</span><span style="color:#89DDFF;">&gt;</span><span style="color:#EEFFFF;"> </span><span style="color:#C3E88D;">重写从网卡发送出报文的目的MAC地址。</span><span style="color:#EEFFFF;"> </span></span>
<span class="line"><span style="color:#FFCB6B;">-k</span><span style="color:#EEFFFF;"> </span><span style="color:#89DDFF;">&lt;</span><span style="color:#C3E88D;">ma</span><span style="color:#EEFFFF;">c</span><span style="color:#89DDFF;">&gt;</span><span style="color:#EEFFFF;"> </span><span style="color:#C3E88D;">重写主网卡发送报文的源MAC地址。</span><span style="color:#EEFFFF;"> </span></span>
<span class="line"><span style="color:#FFCB6B;">-K</span><span style="color:#EEFFFF;"> </span><span style="color:#89DDFF;">&lt;</span><span style="color:#C3E88D;">ma</span><span style="color:#EEFFFF;">c</span><span style="color:#89DDFF;">&gt;</span><span style="color:#EEFFFF;"> </span><span style="color:#C3E88D;">重写从网卡发送报文的源MAC地址。</span></span>
<span class="line"><span style="color:#FFCB6B;">-l</span><span style="color:#EEFFFF;"> </span><span style="color:#89DDFF;">&lt;</span><span style="color:#C3E88D;">loo</span><span style="color:#EEFFFF;">p</span><span style="color:#89DDFF;">&gt;</span><span style="color:#EEFFFF;"> </span><span style="color:#C3E88D;">指定循环的次数。</span></span>
<span class="line"><span style="color:#FFCB6B;">-L</span><span style="color:#EEFFFF;"> </span><span style="color:#89DDFF;">&lt;</span><span style="color:#C3E88D;">limi</span><span style="color:#EEFFFF;">t</span><span style="color:#89DDFF;">&gt;</span><span style="color:#EEFFFF;"> </span><span style="color:#C3E88D;">指定最大的发包数量。可以在确认连接的调试时使用。</span><span style="color:#EEFFFF;"> </span></span>
<span class="line"><span style="color:#FFCB6B;">-m</span><span style="color:#EEFFFF;"> </span><span style="color:#89DDFF;">&lt;</span><span style="color:#C3E88D;">multipl</span><span style="color:#EEFFFF;">e</span><span style="color:#89DDFF;">&gt;</span><span style="color:#EEFFFF;"> </span><span style="color:#C3E88D;">指定一个倍数值，就是必默认发送速率要快多少倍的速率发送报文。</span><span style="color:#EEFFFF;"> </span><span style="color:#C3E88D;">加大发送的速率后，对于DUT可能意味着有更多的并发连接和连接数，特别是对于BT报文的重放，</span><span style="color:#EEFFFF;"> </span><span style="color:#C3E88D;">因为连接的超时是固定的，如果速率增大的话，</span><span style="color:#EEFFFF;"> </span><span style="color:#C3E88D;">留在session表中的连接数量增大，还可以通过修改连接的超时时间来达到该目的。</span></span>
<span class="line"><span style="color:#FFCB6B;">-M</span><span style="color:#EEFFFF;"> </span><span style="color:#C3E88D;">表示不发送“火星”的ip报文，man文件中的定义是</span><span style="color:#EEFFFF;"> </span><span style="color:#F78C6C;">0</span><span style="color:#C3E88D;">/</span><span style="color:#F78C6C;">8</span><span style="color:#C3E88D;">、</span><span style="color:#F78C6C;">172</span><span style="color:#C3E88D;">/</span><span style="color:#F78C6C;">8</span><span style="color:#C3E88D;">、</span><span style="color:#EEFFFF;"> </span><span style="color:#F78C6C;">255</span><span style="color:#C3E88D;">/</span><span style="color:#F78C6C;">8</span><span style="color:#C3E88D;">。</span></span>
<span class="line"><span style="color:#FFCB6B;">-n</span><span style="color:#EEFFFF;"> </span><span style="color:#C3E88D;">在使用-S参数，不对混杂模式进行侦听。</span></span>
<span class="line"><span style="color:#FFCB6B;">-N</span><span style="color:#EEFFFF;"> </span><span style="color:#89DDFF;">&lt;</span><span style="color:#C3E88D;">CIDR1:CIDR2,..</span><span style="color:#EEFFFF;">.</span><span style="color:#89DDFF;">&gt;</span><span style="color:#EEFFFF;"> </span><span style="color:#C3E88D;">通过伪造的NAT，重写IP地址。这个参数应该有很重要的应用，目前没有测试使用。</span></span>
<span class="line"><span style="color:#FFCB6B;">-O</span><span style="color:#EEFFFF;"> </span><span style="color:#C3E88D;">没有测试使用。</span></span>
<span class="line"><span style="color:#FFCB6B;">-p</span><span style="color:#EEFFFF;"> </span><span style="color:#89DDFF;">&lt;</span><span style="color:#C3E88D;">packetrat</span><span style="color:#EEFFFF;">e</span><span style="color:#89DDFF;">&gt;</span><span style="color:#EEFFFF;"> </span><span style="color:#C3E88D;">指定每秒发送报文的个数，指定该参数，其它速率相关的参数被忽略，最后的打印信息不会有速率和每秒发送报文的统计。</span></span>
<span class="line"><span style="color:#FFCB6B;">-P</span><span style="color:#EEFFFF;"> </span><span style="color:#C3E88D;">表示在输出信息中打印PID的信息，用于单用户或单帐户模式下暂停和重启程序。</span></span>
<span class="line"><span style="color:#FFCB6B;">-r</span><span style="color:#EEFFFF;"> </span><span style="color:#89DDFF;">&lt;</span><span style="color:#C3E88D;">rat</span><span style="color:#EEFFFF;">e</span><span style="color:#89DDFF;">&gt;</span><span style="color:#EEFFFF;"> </span><span style="color:#C3E88D;">指定发送的速率。目前-m/-r/-p这3个参数的相互关系。</span></span>
<span class="line"><span style="color:#FFCB6B;">-R</span><span style="color:#EEFFFF;"> </span><span style="color:#C3E88D;">让网卡极限速度发数据包。</span><span style="color:#EEFFFF;"> </span></span>
<span class="line"><span style="color:#FFCB6B;">-t</span><span style="color:#EEFFFF;"> </span><span style="color:#89DDFF;">&lt;</span><span style="color:#C3E88D;">mt</span><span style="color:#EEFFFF;">u</span><span style="color:#89DDFF;">&gt;</span><span style="color:#EEFFFF;"> </span><span style="color:#C3E88D;">指定MTU，标准的10/100M网卡的默认值是1500。</span><span style="color:#EEFFFF;"> </span></span>
<span class="line"><span style="color:#FFCB6B;">-T</span><span style="color:#EEFFFF;"> </span><span style="color:#C3E88D;">Truncate</span><span style="color:#EEFFFF;"> </span><span style="color:#C3E88D;">packets</span><span style="color:#EEFFFF;"> </span><span style="color:#89DDFF;">&gt;</span><span style="color:#EEFFFF;"> </span><span style="color:#C3E88D;">截去报文中MTU大于标准值的部分再发送出去，默认是不发送，skip掉。</span></span>
<span class="line"><span style="color:#FFCB6B;">-v</span><span style="color:#EEFFFF;"> </span><span style="color:#C3E88D;">每发送一个报文都以</span><span style="color:#EEFFFF;"> </span><span style="color:#C3E88D;">tcpdump</span><span style="color:#EEFFFF;"> </span><span style="color:#C3E88D;">的风格打印出对应的信息。</span></span>
<span class="line"><span style="color:#FFCB6B;">-V</span><span style="color:#EEFFFF;"> </span><span style="color:#C3E88D;">查看版本号。</span></span>
<span class="line"><span style="color:#FFCB6B;">-w</span><span style="color:#EEFFFF;"> </span><span style="color:#89DDFF;">&lt;</span><span style="color:#C3E88D;">fil</span><span style="color:#EEFFFF;">e</span><span style="color:#89DDFF;">&gt;</span><span style="color:#EEFFFF;"> </span><span style="color:#C3E88D;">将主网卡发送的报文写入一个文件中，参数后紧跟文件名。</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><h3 id="实例" tabindex="-1">实例 <a class="header-anchor" href="#实例" aria-hidden="true">#</a></h3><p>**1、重放在客户端 ftp 连接的报文 **</p><p>a、在客户端使用 ethereal 抓包，存为 ftp.pcap 文件。</p><p>b、 将 ftp.pcap 文件进行 tcpprep 操作，制作 cache 文件。</p><div class="language-shell line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-darker" tabindex="0"><code><span class="line"><span style="color:#89DDFF;">[</span><span style="color:#EEFFFF;">root@A </span><span style="color:#89DDFF;">~]</span><span style="color:#EEFFFF;"># tcpprep -an client -i ftp.pcap -o ftp.cache –v </span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>c、 将 DUT 设备的两个接口和 PC 的两个接口使用网线连接，使用 tcpreplay 重 放报文。注意防火墙的配置为网桥（透明）模式。</p><div class="language-shell line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-darker" tabindex="0"><code><span class="line"><span style="color:#89DDFF;">[</span><span style="color:#EEFFFF;">root@A </span><span style="color:#89DDFF;">~]</span><span style="color:#EEFFFF;"># tcpreplay -c ftp.cache -i eth0 -j eth1 ftp.pcap -R –v </span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>-R 参数表示全速发送，-v 显示打印信息。</p><p>**2、重放在客户端 BT 连接的报文 **</p><p>a、在实验室 BT 下载一些台湾的娱乐节目和热门的大片，使用 ethereal 抓包， 存为 bt.pcap 文件。注意 pcap 文件大小的控制，对 pc 的内存要求比较高，我保 存了一个 600 多 M 的 pcap 文件用了 40 多分钟，大家有需要可以直接从实验室 copy。</p><p>b、将 bt.pcap 文件进行 tcpprep 操作，制作 cache 文件。</p><div class="language-shell line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-darker" tabindex="0"><code><span class="line"><span style="color:#EEFFFF;"> </span><span style="color:#89DDFF;">[</span><span style="color:#EEFFFF;">root@A </span><span style="color:#89DDFF;">~]</span><span style="color:#EEFFFF;"># tcpprep -an client -i bt.pcap -o bt.cache -C</span><span style="color:#89DDFF;"> &quot;</span><span style="color:#C3E88D;">100M BT Packet</span><span style="color:#89DDFF;">&quot;</span><span style="color:#EEFFFF;"> –v</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>制作 cache 文件，在 cache 文件中写入“100M BT Packet”的注释。</p><p>c、使用 tcpreplay 重放报文。</p><div class="language-shell line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-darker" tabindex="0"><code><span class="line"><span style="color:#89DDFF;">[</span><span style="color:#EEFFFF;">root@A </span><span style="color:#89DDFF;">~]</span><span style="color:#EEFFFF;"># tcpreplay -c bt.cache -i eth0 -j eth1 bt.pcap -v –R </span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>**3、重放 tftp 服务器上抓到的报文 **</p><p>a、在 tftp 服务器上使用 ethereal 抓包，存为 tftp.pcap 文件。</p><p>b、将 pcap 文件进行 tcpprep 的操作，制作 cache 文件。</p><div class="language-shell line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-darker" tabindex="0"><code><span class="line"><span style="color:#89DDFF;">[</span><span style="color:#EEFFFF;">root@A </span><span style="color:#89DDFF;">~]</span><span style="color:#EEFFFF;"># tcpprep -an server -i tftp.pcap -o tftp.cache –v </span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>注意：我在测试的时候犯了一个错误，使用 DUT 的 tftp 升级来做实验，同时穿 过 DUT 重放报文，结果在网卡发送报文的后，DUT 的 mac 地址做了的回应，导致 交互过程没有穿过 DUT，这个问题比较搞笑，上午弄了半天才发现原因，开始还 以为 udp 的连接不能重放。</p><p>c、使用 tcpreplay 重放报文。</p><div class="language-shell line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-darker" tabindex="0"><code><span class="line"><span style="color:#89DDFF;">[</span><span style="color:#EEFFFF;">root@A </span><span style="color:#89DDFF;">~]</span><span style="color:#EEFFFF;"># tcpreplay -c tftp.cache -i eth0 -j eth1 tftp.pcap –v</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div>`,28),o=[e];function F(c,t,r,y,E,i){return n(),a("div",null,o)}const d=s(l,[["render",F]]);export{C as __pageData,d as default};
